# 车险变动成本明细分析系统 · 仓库指南

## AI代理指令与全局设定

本文件用于为AI代理提供项目相关的全局设定和特定指令。请将所有与AI开发直接相关的配置、要求和偏好在此处进行维护。

### AI代理角色与职责
- 作为世界顶级的架构师和编程专家，提供高质量的代码和架构设计。
- 作为世界顶级的麦肯锡专家，提供专业的业务分析和战略建议。
- 作为世界顶级的车险经营大师和精算师，确保业务逻辑的准确性和专业性。
- 作为Supabase专家，善于描述和理解数据结构。
- 专注于构建智能化车险变动成本明细分析平台，实现数据驱动的精准决策。

### AI开发通用规则
- 生成代码时添加函数级注释，注释使用中文。
- 始终使用中文回复。
- 将PRD和README视为活文档，与功能变化同步更新。
- 涉及操作步骤，需要详细列明没有任何歧义且符合最佳实践的步骤。

### 用户特定要求

#### 数据规范严格遵循要求
- **筛选选项标准化**：所有筛选选项必须严格符合《字段分类与筛选项清单.md》和《字段对照表.md》中定义的规范标准
- **字段命名一致性**：确保筛选条件与参考文件中的字段分类、命名规则和逻辑关系保持完全一致
- **选项枚举准确性**：筛选组件的可选项必须与实际数据中的唯一值完全匹配，不得添加或遗漏任何选项

#### 具体筛选维度要求（16个）
1. **起保年度** (policy_start_year) - 当前数据：2024
2. **周序号** (week_number) - 当前数据：28
3. **业务类型分类** (business_type_category) - 16项精确选项
4. **机构层级** (chengdu_branch) - 2项：中支、成都
5. **三级机构/城市** (third_level_organization) - 13项精确选项
6. **客户三级分类** (customer_category_3) - 11项精确选项
7. **险种类型** (insurance_type) - 2项：交强险、商业保险
8. **是否新能源车** (is_new_energy_vehicle) - 布尔值：False、True
9. **保障方案** (coverage_type) - 3项：主全、交三、单交
10. **是否过户车** (is_transferred_vehicle) - 布尔值：False、True
11. **新续转状态** (renewal_status) - 3项：新保、续保、转保
12. **车险评级** (vehicle_insurance_grade) - 8项：A、B、C、D、E、F、G、X
13. **高速风险等级** (highway_risk_grade) - 6项：A、B、C、D、E、X
14. **大货车评分** (large_truck_score) - 6项：A、B、C、D、E、X
15. **小货车评分** (small_truck_score) - 6项：A、B、C、D、E、X
16. **终端来源** (terminal_source) - 7项精确选项

#### 核心指标体系（16个）
**保费类指标（4个）**
- 保费收入（万元）、保费增长率（%）、平均保费（元）、保费集中度（%）

**赔款类指标（4个）**
- 赔款支出（万元）、满期赔付率（%）、平均赔款（元）、大案件占比（%）

**成本类指标（4个）**
- 变动成本（万元）、变动成本率（%）、费用率（%）、综合成本率（%）

**效率类指标（4个）**
- 承保件数（件）、出险件数（件）、出险率（%）、人均产能（万元）

#### 数据处理规范
- **比率字段处理**：满期赔付率、费用率、变动成本率等字段以小数形式存储，显示时需×100转换为百分比
- **空值处理**：车险评级、高速风险等级、小货车评分等字段存在空值，前端显示为"未评级"
- **数据验证**：确保所有筛选选项与实际数据保持同步，定期验证数据一致性

## 项目整体架构

### 数据处理层（根目录）
- **Python 数据工具**：`数据转换脚本.py`、`车险数据一体化处理脚本.py`、`车险数据拆分脚本.py`，权限相关的辅助脚本
- **数据文件夹**：
  - 原始输入：`数据源/`（Excel文件）
  - 清洗输出：`转换后数据/`（CSV文件）
  - 按年度拆分：`按年度拆分数据/`（分年度CSV）
- **配置与环境**：本地Python虚拟环境（`venv/`），环境配置（`.env`）
- **规范文档**：`字段分类与筛选项清单.md`、指标逻辑文档等

### 前端仪表盘层（car-insurance-dashboard/）
- **源码结构**：使用Next.js App Router架构
  - 页面与API路由：`src/app/`
  - UI组件：`src/components/`
  - 状态管理：`src/contexts/`
  - 业务服务：`src/services/`
  - 工具函数：`src/utils/`
  - 类型定义：`src/types/`
  - 数据处理：`src/data/`
  - 静态资源：`public/`
- **路径别名**：使用 `@/` 前缀（例如：`import { DataProcessor } from '@/utils/dataProcessor'`）
- **测试文件**：就近放置在 `src/**/__tests__` 和 `*.test.{ts,tsx}`

## 构建、测试与开发命令

### 前端仪表盘（car-insurance-dashboard/）
- **环境准备**：`cd car-insurance-dashboard && npm install`
- **开发服务器**：`npm run dev` — 启动Next.js开发服务器（http://localhost:3000）
- **生产构建**：`npm run build` — 生产构建
- **生产启动**：`npm run start` — 运行已构建应用
- **代码检查**：`npm run lint` — 运行ESLint（Next.js配置）
- **测试命令**：
  - `npm test` — 运行Jest测试
  - `npm run test:watch` — 监听模式
  - `npm run test:coverage` — 输出覆盖率
  - 示例：`npm test -- src/utils/__tests__/dataProcessor.test.ts` 可仅运行某个测试文件

### 数据处理脚本（根目录）
- **环境激活**：`source venv/bin/activate`（若使用虚拟环境）
- **数据处理**：`python3 车险数据一体化处理脚本.py`（按需调整脚本与路径）
- **数据拆分**：`python3 车险数据拆分脚本.py`
- **权限管理**：`python3 权限切换脚本.py`

## 编码风格与命名约定

### Python 数据处理规范
- **代码风格**：遵循 PEP 8，4 空格缩进，函数/变量使用 `snake_case`
- **文件命名**：保持中文文件名一致性；新文件避免使用空格
- **脚本设计**：保持脚本幂等且路径可配置
- **提交规范**：提交小而聚焦的更改

### TypeScript/React 前端规范
- **语言与框架**：TypeScript；仅使用 React 函数组件
- **缩进与格式**：2 空格；倾向早返回与小而纯的辅助函数
- **文件命名**：
  - 组件：使用 PascalCase（如 `KPISummary.tsx`）
  - 工具/服务：使用 camelCase（如 `dataProcessor.ts`）
  - Hook：以 `use*` 开头
- **样式规范**：使用 Tailwind CSS 工具类；非必要避免内联样式
- **导入规范**：优先使用别名（`@/…`）而非相对路径
- **代码质量**：遵循 ESLint（Next 配置）与 Tailwind 规范；在 `src/` 下优先使用函数式组件与类型化的 props

## 测试指南

### 前端测试规范
- **测试框架**：Jest + Testing Library（jest-environment-jsdom）
- **测试位置**：靠近源码的 `src/**/__tests__` 或 `*.test.{ts,tsx}`
- **覆盖率要求**：全局阈值 70%；新增代码时保持或提升
- **参考示例**：`test_calculation_validation.js`、`test_key_metrics.js`
- **运行方式**：通过 `npm test` 运行；可指定具体文件
- **代理要求**：当修改 `utils/` 或 `services/` 逻辑时，更新或新增聚焦的测试

### 数据脚本测试规范
- **当前状态**：暂未建立正式测试套件
- **新增测试建议**：
  - 使用 `tests/` 下的 `pytest`
  - 在 `数据源/` 与 `转换后数据/` 中添加可复现实验的样例输入/输出夹具
  - 确保数据处理脚本的幂等性和可重复性

## 提交与 Pull Request 规范

### 提交规范
- **格式标准**：遵循 Conventional Commits
  - 类型：`feat:`、`fix:`、`chore:`、`docs:`、`refactor:`、`test:`
  - 范围可选：如 `feat(charts): add Pareto chart`
- **提交原则**：使用祈使语气，范围简洁，提交小而聚焦的更改

### Pull Request 规范
- **必需内容**：
  - 包含摘要、动机/目的、背景说明
  - UI变更：提供截图
  - 数据变更：提供样例输入/输出差异
  - 关联相关issue与测试说明
- **质量要求**：
  - 确保 `npm run lint` 与 `npm test` 通过
  - 标注破坏性变更
  - 附运行/测试说明

## 安全与配置

### 环境配置安全
- **机密管理**：
  - 不要提交 `.env*` 文件
  - 前端使用 `.env.local`
  - 仅在确需暴露给客户端时使用 `NEXT_PUBLIC_*`
- **路径配置**：输入/输出路径使用变量替代硬编码
- **敏感数据**：将密钥/路径存于 `.env`；不要提交敏感数据

### 数据安全规范
- **原始数据保护**：非必要不要修改或提交 `数据源/` 下的原始文件
- **数据流架构**：services 拉取 → utils 转换 → components 渲染
- **业务逻辑分离**：尽量将业务逻辑移出组件

### 面向代理的开发要求
- **改动原则**：保持改动最小且在既定范围内
- **模式遵循**：遵循现有模式与路径别名
- **测试更新**：当修改 `utils/` 或 `services/` 逻辑时，更新或新增聚焦的测试
