# 📌 商业险折前保费 | `original_commercial_premium`

---

## 1. 指标定义
- **字段名**：`original_commercial_premium`
- **单位**：万元
- **类型（DB 存储）**：`numeric(18,4)`
- **展示精度**：保留 1 位小数
- **适用范围**：仅限 `insurance_type = '商业险'`
- **含义**：将商业险的**跟单保费**按**商业险自主定价系数**“还原”为**折前保费**（系数作用前的保费基数）。用于口径统一、系数影响拆解及后续加权计算。

---

## 2. 计算公式（公司统一口径）
```text
original_commercial_premium(万元)
= documented_premium_in_10k / commercial_auto_underwriting_factor
  ，仅统计 insurance_type = '商业险'

	•	documented_premium_in_10k：跟单保费（万元）
	•	commercial_auto_underwriting_factor：商业险自主定价系数（系数，存库为小数）
	•	仅在 insurance_type = '商业险' 且 commercial_auto_underwriting_factor > 0 时计算

⸻

3. 计算顺序
	1.	维度筛选：insurance_type = '商业险'
	2.	行级还原：row_original = documented_premium_in_10k / commercial_auto_underwriting_factor
	3.	目标维度聚合：SUM(row_original) → original_commercial_premium
	4.	展示层：ROUND(original_commercial_premium, 1)

⸻

4. 注意事项
	•	口径单一：严禁混入交强险；交强险无该指标。
	•	分母校验：commercial_auto_underwriting_factor 必须 > 0，0 或空值时结果置为 NULL。
	•	单位一致：均为万元口径，无需元↔万元换算。
	•	用途：用于计算商业险自主定价系数（加权）、评估系数对保费的放大/缩小效应。

⸻

5. 实现示例（Postgres / Supabase SQL）

WITH filtered AS (
  SELECT
    policy_start_year,
    week_number,
    third_level_organization,
    documented_premium_in_10k,
    commercial_auto_underwriting_factor
  FROM auto_insurance_metrics
  WHERE insurance_type = '商业险'
),
restored AS (
  SELECT
    policy_start_year,
    week_number,
    third_level_organization,
    CASE
      WHEN commercial_auto_underwriting_factor > 0
        THEN documented_premium_in_10k / commercial_auto_underwriting_factor
      ELSE NULL
    END AS row_original_premium
  FROM filtered
)
SELECT
  policy_start_year,
  week_number,
  third_level_organization,
  ROUND(SUM(row_original_premium), 1) AS original_commercial_premium
FROM restored
GROUP BY 1,2,3
ORDER BY policy_start_year, week_number, third_level_organization;


⸻

6. 稽核与诊断
	•	关系核对：

documented_premium_in_10k ≈ original_commercial_premium × (加权商业险自主定价系数)


	•	异常排查：若“折前保费”长期异常偏低/偏高，检查是否混入交强险、系数空值、或批改口径不一致。

⸻


```markdown
# 📌 商业险自主定价系数 | `commercial_auto_underwriting_factor`

---

## 1. 指标定义
- **字段名**：`commercial_auto_underwriting_factor`
- **单位**：系数
- **类型（DB 存储）**：`numeric(12,6)`
- **展示精度**：保留 4 位小数
- **适用范围**：仅限 `insurance_type = '商业险'`
- **含义**：商业险费改后用于调节保费水平的系数。**该指标在汇总口径上属于“类似率/均值”的指标，必须先计算绝对值（折前商业险保费），再据此做加权计算。**

---

## 2. 计算公式（公司统一口径）
### 2.1 行级关系（用于复原绝对值）
```text
documented_premium_in_10k
= original_commercial_premium × commercial_auto_underwriting_factor

2.2 汇总口径（加权系数）

加权商业险自主定价系数
= ( Σ documented_premium_in_10k ) / ( Σ original_commercial_premium )
，维度限定为 insurance_type = '商业险'

	•	先复原 original_commercial_premium = documented_premium_in_10k / commercial_auto_underwriting_factor
	•	再按目标维度做加权：保费加权而非简单算术平均

⸻

3. 计算顺序
	1.	维度筛选：insurance_type = '商业险'
	2.	复原绝对值：row_original = documented_premium_in_10k / commercial_auto_underwriting_factor（仅当系数>0）
	3.	聚合绝对值：
	•	sum_doc = Σ(documented_premium_in_10k)
	•	sum_ori = Σ(row_original)
	4.	加权计算：
	•	weighted_factor = sum_doc / NULLIF(sum_ori,0)
	5.	展示层：ROUND(weighted_factor, 4)

⸻

4. 注意事项
	•	只对商业险有效：交强险没有该系数。
	•	先绝对值、后系数：与“率/均值”类相同，必须先复原绝对值（折前商业险保费），再计算加权系数。
	•	数据稽核：sum_doc ≈ sum_ori × weighted_factor；若不符，排查混口径、批改、或缺失值。
	•	分母保护：当 sum_ori = 0 或全部系数无效时，结果置为 NULL。

⸻

5. 实现示例（Postgres / Supabase SQL）

WITH commercial AS (
  SELECT
    policy_start_year,
    week_number,
    third_level_organization,
    documented_premium_in_10k,
    commercial_auto_underwriting_factor
  FROM auto_insurance_metrics
  WHERE insurance_type = '商业险'
),
restored AS (
  SELECT
    policy_start_year,
    week_number,
    third_level_organization,
    documented_premium_in_10k,
    CASE
      WHEN commercial_auto_underwriting_factor > 0
        THEN documented_premium_in_10k / commercial_auto_underwriting_factor
      ELSE NULL
    END AS row_original_premium
  FROM commercial
),
agg AS (
  SELECT
    policy_start_year,
    week_number,
    third_level_organization,
    SUM(documented_premium_in_10k) AS sum_doc,
    SUM(row_original_premium)     AS sum_ori
  FROM restored
  GROUP BY 1,2,3
)
SELECT
  policy_start_year,
  week_number,
  third_level_organization,
  CASE
    WHEN sum_ori > 0
      THEN ROUND(sum_doc / sum_ori, 4)
    ELSE NULL
  END AS commercial_auto_underwriting_factor
FROM agg
ORDER BY policy_start_year, week_number, third_level_organization;


⸻

6. 口径说明
	•	第一原则：先复原“商业险折前保费”（绝对值），再以“保费加权”的方式计算系数。
	•	与其它指标的关系：
	•	original_commercial_premium 是前置依赖；
	•	结果用于解释“系数变动对商业险保费的影响”，以及商业险与交强险结构差异。